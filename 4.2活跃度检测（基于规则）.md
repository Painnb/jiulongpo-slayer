## 1. 数据预处理与存储

- **数据清洗与时间对齐**
   对上报的各类车辆数据（如状态信息、心跳数据、功能订阅、位置信息等）进行清洗，确保各字段数据完整且时间戳统一为东八区 UTC 毫秒值。
- **车辆数据存储与索引**
   对于每辆车，根据车辆编号（vehicleId）建立数据缓存或数据库索引，记录近期的上报数据及各类事件时间（例如心跳、状态上报时间）。

------

## 2. 活跃度指标设计

车辆活跃度检测的目的是判断车辆在一段时间内是否处于“活跃”状态，即数据上报是否频繁、车辆是否处于运动或在线状态。主要指标包括：

### 2.1 上报频率检测

- **定义时间窗口**
   设定一个固定的检测时间窗口（例如：过去 5 分钟或 1 小时），统计该时间段内车辆上报的数据条数。
- **判断条件**
  - **高频上报**：若车辆在窗口内上报次数大于预设阈值（例如，每分钟至少 1 次，5 分钟内至少 5 条数据），认为该车辆数据上报正常，处于活跃状态。
  - **低频上报**：若上报次数低于阈值，可能存在车辆数据断报或通信异常，此时可判定车辆活跃度较低。

### 2.2 心跳数据检测

- **心跳包检查**
   车辆端会周期性发送心跳消息，用于维持与云端的 TCP 连接。
  - 若连续心跳包丢失或延时超过预设值（例如 3 秒内未收到有效心跳），则认为车辆通信连接存在异常，从而影响活跃度判断。

### 2.3 行驶状态判断

- **运动状态与静止状态**
   除了数据上报频率外，还可利用车辆状态数据中的车速、发动机转速、加速度等指标判断车辆是否处于运行状态。
  - 当车辆的 `speedSimu` 或 `gSpeed` 显示速度大于某一阈值（例如 1 m/s）时，可认为车辆正处于行驶状态；
  - 若车辆长时间处于静止状态，则可以进一步结合上报频率进行判断，认为车辆可能进入休眠或掉线状态。

### 2.4 活跃度评分

将上述各项指标融合，构造一个综合活跃度评分（activeScore）：

- **公式示例**：
   activeScore = w₁ × (上报频率得分) + w₂ × (心跳连通性得分) + w₃ × (行驶状态得分)
   其中，w₁、w₂、w₃ 为各指标权重，可根据实际业务需求调节。
- **得分解释**：
  - 每一项指标可设定一个 0~1 之间的得分，最终 activeScore 超过预设阈值（例如 0.7）时认为车辆处于活跃状态；否则判定为低活跃或离线状态。

------

## 3. 具体检测流程

1. **数据采集与更新**
    实时接收车辆上报数据，将最新消息按 vehicleId 分组存储，并更新每辆车的最近上报时间。

2. **指标计算**

   - **上报频率**：统计当前时间窗口内的消息条数，计算频率得分（例如：实际上报次数与预设次数的比值，超过 1 时得分取 1）。
   - **心跳连通性**：检测心跳包间隔，若连续收到有效心跳则得满分，否则根据延时或丢包情况降低得分。
   - **行驶状态**：根据当前车辆速度和加速度判断车辆是否正处于运动状态，运动状态可给高得分；静止状态给低得分。

3. **活跃度综合评估**
    利用公式计算 activeScore，并与预设阈值进行对比：

   - 如果 activeScore ≥ 阈值，则判定车辆活跃；
   - 否则视为活跃度较低，需要进一步检测或报警（例如触发通信链路异常报警）。

4. **结果输出**
    针对每辆车生成如下 JSON 记录，记录车辆活跃状态及相关细节，供后续调度或统计分析：

   ```json
   {
     "vehicleId": "ABC12345",
     "timestamp": 1679552234567,
     "isActive": true,
     "activeScore": 0.82,
     "details": {
       "reportFrequencyScore": 1.0,
       "heartbeatScore": 0.9,
       "motionStateScore": 0.75,
       "lastReportInterval": 45  // 单位：秒
     }
   }
   ```

