### 1. 所需数据字段

车辆活跃度检测依赖于车云数据中的多项字段，主要包括：

- **车辆基本信息**
  - **vehicleId**：车辆唯一标识（要求固定 8 字节且在云平台中已注册）。
  - **messageId**：消息序号，保证消息连续性。
- **时间戳数据**
  - **timestampGNSS**、**timestamp3**、**timestamp4**等，用于记录数据采集时间，便于检测数据的实时性和连续性。
- **状态数据**
  - **速度信息**：
    - **velocityGNSS**：GNSS 提供的车速（单位通常为 0.01 m/s）；
    - **velocityCAN**：CAN 总线采集的车速数据。
  - **加速度信息**：
    - **accelerationLon**（纵向加速度）、
    - **accelerationLat**（横向加速度）、
    - **accelerationVer**（垂向加速度），用于判断车辆是否处于运动状态。
  - **转向数据**：
    - **steeringAngle**：方向盘转角（原始值以 1e-4° 表示，需转换为实际角度）；
    - **yawRate**：横摆角速度，反映车辆绕垂直轴的旋转情况。
  - **发动机状态**：
    - **engineSpeed**：发动机转速（rpm）；
    - **engineTorque**：发动机扭矩数据。
- **制动及驾驶模式**
  - **brakeFlag**、**brakePos**、**brakePressure**：反映制动状态；
  - **driveMode**：车辆当前驾驶模式，标识车辆是否处于自动驾驶、人工驾驶或休眠状态。
- **连接与心跳数据**
  - 心跳消息及其回复情况，用于判断车辆是否与云平台保持实时连接。
- **消息频率**
  - 通过统计在一定监测窗口内的消息数量来判断数据上报的频率。

------

### 2. 活跃度检测的业务逻辑

车辆活跃度检测主要包含以下几个检测模块，每个模块都有具体的阈值设定和逻辑判断：

#### 2.1 消息频率检测

- **逻辑说明**：
   统计车辆在一个预设时间窗口内（例如 5 分钟或 1 小时）的状态消息数量。
  - **阈值设定**：
    - 例如，在 5 分钟内至少应收到 5 条状态消息（平均 1 条/分钟）。
    - 如果收到消息数低于该标准，则可能表明车辆上报频率不足或车辆处于休眠/离线状态。
- **需要数据**：
  - 各消息中的时间戳（如 timestampGNSS）
  - 消息接收记录（messageId 序列、接收时间）

#### 2.2 状态变化分析

- **逻辑说明**：
   通过检测车辆状态数据来判断车辆是否处于“运动”状态或处于静止、休眠状态。
  - **速度检测**：
    - 如果连续多条消息中，车辆速度（velocityGNSS 或 velocityCAN）均低于 1 m/s，则认为车辆处于静止状态。
    - 若大部分消息显示车速超过 1 m/s，则车辆处于运动状态，活跃度较高。
  - **发动机状态**：
    - 当 engineSpeed > 50 rpm 时，表明发动机正在运行；
    - 如果长时间（例如连续 3 条以上消息） engineSpeed 均低于 50 rpm，可能说明车辆进入休眠状态或熄火。
  - **驾驶模式**：
    - driveMode 数值应在合法范围内（如 1～9），其中自动驾驶或云控支持驾驶时，车辆一般处于较高活跃状态；
    - 如果 driveMode 显示为“非驾驶”或休眠模式，则视为低活跃。
- **需要数据**：
  - 速度字段（velocityGNSS、velocityCAN）
  - 发动机数据（engineSpeed、engineTorque）
  - 驾驶模式（driveMode）

#### 2.3 心跳与在线状态检测

- **逻辑说明**：
   车辆与云平台之间通过定期发送心跳消息保持连接，检测心跳消息的连续性和及时性来判断车辆是否在线。
  - **阈值设定**：
    - 预设心跳周期为 1 秒，若连续 3 次心跳未收到回复，则认为车辆可能已离线或连接不稳定。
  - **判断要点**：
    - 检查心跳消息的时间间隔是否在合理范围内；
    - 结合实际网络延迟情况设置一定的容错范围（例如允许 1～2 秒的偶发延迟）。
- **需要数据**：
  - 心跳消息与回复记录
  - 心跳消息的时间戳

#### 2.4 综合评分与活跃度评估

- **逻辑说明**：
   将消息频率、状态变化和心跳检测三项指标进行加权综合，计算车辆的活跃度分值。
  - **评分方案**：
    - 消息频率得分（占比 40%）：如果在监测窗口内消息数量达到预设标准，得满分，否则按比例扣分；
    - 状态变化得分（占比 40%）：若超过 70% 的状态消息显示车辆处于运动状态（速度 > 1 m/s、engineSpeed > 50 rpm），得满分；否则按比例扣分；
    - 心跳得分（占比 20%）：连续心跳正常则满分，否则每次心跳超时扣除相应分值（例如每次扣 33 分）。
  - **阈值判断**：
    - 最终综合得分大于 80 分，认为车辆处于高活跃状态；
    - 综合得分介于 50 至 80 分之间，视为部分活跃；
    - 得分低于 50 分，判定车辆处于低活跃或离线状态。
- **需要数据**：
  - 前述各模块产生的指标与评分
  - 消息记录、状态数据统计及心跳检测结果

------

### 3. 详细逻辑流程总结

1. **数据预处理**
   - 从每条 JSON 消息中提取 vehicleId、messageId、时间戳、位置、速度、加速度、转向、发动机状态、驾驶模式、心跳数据等字段，进行单位转换和格式校验。
2. **消息频率统计**
   - 在设定的时间窗口内（如 5 分钟），统计每辆车的消息数量；
   - 若数量低于 5 条（或相应标准），记录低上报频率，提示可能车辆处于休眠或离线状态。
3. **状态变化分析**
   - 分析连续消息中车辆速度是否大于 1 m/s，发动机转速是否高于 50 rpm；
   - 根据连续状态数据判断车辆是否在行驶或长时间处于静止状态；
   - 检查 driveMode 字段是否反映出车辆处于正常驾驶状态。
4. **心跳检测**
   - 检查车辆是否按 1 秒周期发送心跳消息；
   - 若连续 3 次心跳超时，则认为车辆连接异常或离线。
5. **综合评分与活跃度判定**
   - 按照消息频率（40%）、状态变化（40%）和心跳检测（20%）三个维度计算综合得分；
   - 将得分与预设阈值对比，确定车辆处于“高活跃”、“部分活跃”或“低活跃/离线”状态。
6. **输出活跃度报告**
   - 生成结构化报告，内容包括车辆基本信息、监测窗口内的消息统计、各项指标得分以及最终的活跃度状态；
   - 报告可用于实时监控、调度管理和异常告警。
