### 1. 数据预处理与标准化

- **数据清洗与时间对齐**
   对上报数据（如 JSON 格式的 SPaT 消息或车辆运行状态数据）进行预处理，包括去除噪音、校正缺失值、对齐时间戳（注意所有时间均为东八区 UTC 毫秒值）。
- **坐标、角度、加速度等数值归一**
   根据数据定义（例如经纬度、加速度单位等）对原始数据进行转换和标准化处理，确保后续规则计算时数值正确。

------

### 2. 具体规则设计

#### 2.1 GPS 跳变检测规则

**目的**：识别连续两条记录中 GPS 坐标变化超过物理可能范围，排查定位误差或数据采集异常。
 **实现逻辑**：

- **输入数据**：相邻两条记录的 `latitude`、`longitude` 和 `timestamp`。

- **计算步骤**：

  - 采用 Haversine 公式计算两点间直线距离（单位：米）。
  - 计算时间差 Δt（秒）：
     Δt = (curr.timestamp – prev.timestamp) / 1000
  - 计算瞬时速度： v = distance / Δt

- **判断条件**：

  - 例如：对于车辆，若 v > 100 m/s（约360 km/h）则认为数据异常。

- **异常输出示例**：

  ```json
  {
    "timestamp": 1679552234567,
    "isAnomalous": true,
    "anomalyType": "gps_jump",
    "details": {
      "distance": 120,
      "timeDifference": 1,
      "calculatedSpeed": 120,
      "threshold": 100
    }
  }
  ```

------

#### 2.2 速度异常检测规则

**目的**：判断单条记录中上报的车辆速度是否超出正常范围，或连续数据中速度变化是否突兀。
 **实现逻辑**：

- **输入数据**：单条记录中的 `speedSimu` 或 `gSpeed`。

- **判断条件**：

  - 例如：车辆运行数据中若 `speedSimu` 超过 50 m/s（可根据实际情况调整，如 60 m/s）则视为异常。
  - 同时可对连续数据进行突变监测（例如从低速突然跃升）。

- **异常输出示例**：

  ```json
  {
    "timestamp": 1679552234567,
    "isAnomalous": true,
    "anomalyType": "speed_outlier",
    "details": {
      "speedSimu": 55.0,
      "expectedMax": 50.0
    }
  }
  ```

------

#### 2.3 加速度异常检测规则

**目的**：检测加速度数据是否存在异常跳变或偏离正常重力加速度。
 **实现逻辑**：

- **输入数据**：单条记录中的 `accelerometerSimu` 数组（格式：[x, y, z]）。

- **计算步骤**：

  - 计算加速度模长：
     acc_mag = √(x² + y² + z²)

- **判断条件**：

  - 对于静止状态，理论上 acc_mag 应接近 9.8 m/s²；若 |acc_mag − 9.8| > 5 m/s²，则异常。
  - 同时检测连续记录间模长变化量，若变化大于 8 m/s²，也判定为异常。

- **异常输出示例**：

  ```json
  {
    "timestamp": 1679552234567,
    "isAnomalous": true,
    "anomalyType": "acceleration_spike",
    "details": {
      "acceleration_magnitude": 15.3,
      "expected": 9.8,
      "delta": 5.5
    }
  }
  ```

------

#### 2.4 航向角（Heading）异常检测规则

**目的**：监控航向数据是否发生大幅度跳变，以判断是否存在数据异常或传感器故障。
 **实现逻辑**：

- **输入数据**：连续两条记录中的 `headingSimu`（单位可能为度或更精细单位，需归一）。

- **计算步骤**：

  - 计算相邻记录中航向角的差值：
     Δheading = |curr_heading − prev_heading|

- **判断条件**：

  - 若 Δheading > 150°（考虑跨越 0°/360° 边界时的情况），则标记为异常。

- **异常输出示例**：

  ```json
  {
    "timestamp": 1679552234567,
    "isAnomalous": true,
    "anomalyType": "heading_jump",
    "details": {
      "previous_heading": 10,
      "current_heading": 170,
      "delta": 160
    }
  }
  ```

------

#### 2.5 姿态（Orientation）异常检测规则

**目的**：判断设备姿态数据（如 roll、pitch、yaw）是否存在突变，检测设备是否受到外力冲击或传感器异常。
 **实现逻辑**：

- **输入数据**：连续两条记录中的 `orientationSimu` 数组（例如：[roll, pitch, yaw]）。

- **判断条件**：

  - 分别计算各角度的变化值，若任一角度的变化超过 30°（可依据实际情况动态调整）则标记为异常。

- **异常输出示例**：

  ```json
  {
    "timestamp": 1679552234567,
    "isAnomalous": true,
    "anomalyType": "orientation_jump",
    "details": {
      "angle_change": 35,
      "threshold": 30
    }
  }
  ```

------

#### 2.6 其他辅助规则（可选）

- **磁力计数据检测**
   若上报的 `magSimu` 数值超出 ±100 µT 的合理范围，则认为可能存在传感器故障。
- **时间戳连续性检测**
   检查连续数据中 `timestamp` 是否存在倒退或异常跳跃，若发现数据时序错误也可视为异常。

------

### 3. 规则整合与处理流程

1. **数据预处理**
    对车辆云端数据进行清洗、归一化和时间对齐，确保所有数据项在同一基准下进行比较。
2. **逐条规则检测**
    每收到一条新的数据记录后：
   - 针对 GPS、速度、加速度、航向和姿态依次计算各自指标；
   - 对连续数据（例如两条记录之间）进行比较，计算距离、速度、角度差值和加速度变化；
   - 分别判断是否超过设定阈值。
3. **异常汇总与输出**
   - 若检测到一项或多项异常，则生成异常记录，包含 `timestamp`、`isAnomalous` 标识（true/false）、 `anomalyType`（单项或多个异常类型）以及详细的计算参数；
   - 输出的异常 JSON 数据可存入日志系统，触发报警，或用于后续的业务处理（如数据修正、设备状态检测等）。
4. **后续处理**
   - 异常记录后续可用于统计分析、历史数据对比以及优化规则阈值；
   - 当数据补发或重新采集后，可对比异常记录与实际情况，调整检测策略