### 1. 所需数据字段

在车云数据中，每条数据通常采用 JSON 格式上传，关键字段包括但不限于：

- **基本标识信息**
  - **vehicleId**：车辆唯一标识，要求固定 8 字节，必须在云端注册；
  - **messageId**：消息编号，用于记录消息顺序，必须为自增正整数；
  - **时间戳**：如 **timestampGNSS**、**timestamp3**、**timestamp4**，均为 UTC 毫秒数（东八区），用于标识数据采集时刻，要求与当前服务器时间的差异在允许范围内（建议不超过 ±5 分钟）。
- **位置与环境数据**
  - **position**：包含经度、纬度和高程数据；
    - 经度（longitude）：以 1e-7° 为单位，经过转换应在 [–180, 180] 度之间；
    - 纬度（latitude）：以 1e-7° 为单位，范围在 [–90, 90] 度；
    - 高程（elevation）：以分米为单位，实际值要求在 [-5000, 65000]（即 -5000 dm 至 65000 dm）；
  - **heading**：航向角数据，单位为 1e-4°，指示车辆运动方向。
- **速度与加速度数据**
  - **velocityGNSS**：由 GNSS 提供的车辆速度，单位通常为 0.01 m/s；
  - **velocityCAN**：来自 CAN 总线的车速数据，单位同上；
  - **加速度数据**：
    - **accelerationLon**：车辆纵向加速度，单位为 0.01 m/s²，需转换后判断；
    - **accelerationLat**：横向加速度；
    - **accelerationVer**：垂向加速度。
- **转向与角速度数据**
  - **steeringAngle**：方向盘转角，原始数据以 1e-4° 表示，转换后得到实际角度；
  - **yawRate**：横摆角速度，单位可能为 0.01°/s，反映车辆绕垂直轴的旋转速度。
- **制动系统数据**
  - **brakeFlag**：制动踏板状态，0 表示未踩，1 表示踩下（若为 0xFF 则为异常）；
  - **brakePos**：制动踏板开度，单位为 0.1%；
  - **brakePressure**：主缸制动压力，单位为 0.01 MPa。
- **发动机状态数据**
  - **engineSpeed**：发动机转速，单位为 rpm；
  - **engineTorque**：发动机输出扭矩，单位为 0.01 Nm；
  - **fuelConsumption**：油耗数据，单位为 0.01 L/100km。
- **驾驶状态信息**
  - **driveMode**：车辆驾驶模式，取值应符合预定义范围（如 1~9，其中 0xFF 表示缺省）；
  - 其他补充数据：如 **tapPos**（档位信息）、目的地位置（destLocation）、途经点（passPoints）等，根据实际场景也可用于辅助判断。

------

### 2. 详细业务逻辑与检测流程

整个检测流程可以划分为以下几个步骤，每一步均基于上述数据字段和具体阈值进行判断：

#### 2.1 数据解析与预处理

- **字段提取**：从 JSON 中提取所有关键数据字段，并校验格式（例如 vehicleId 的长度、消息编号是否合理）。
- **单位转换**：
  - 将经纬度数据按 1e-7 转换为实际度数；
  - 将方向盘转角数据除以 10,000 得到实际角度；
  - 将速度、加速度数据根据协议中的单位（通常为 0.01 倍）转换为实际数值；
  - 对制动开度、压力以及发动机、油耗等数据同样进行必要的单位换算。

#### 2.2 基础有效性检查

- **车辆标识与消息连续性**
  - 检查 vehicleId 是否为 8 字节有效注册码；
  - 确认 messageId 为正且处于合理的自增序列中，防止乱序或重复数据。
- **时间戳验证**
  - 将各个时间戳与当前系统时间对比，确保数据采集时刻与实际时刻的差异不超过 300,000 毫秒（5 分钟）；
  - 如果数据中出现 0xFF… 等异常标识，直接判定为无效数据。
- **位置数据验证**
  - 经度必须转换到 [–180, 180]；
  - 纬度转换后应在 [–90, 90]；
  - 高程值需在协议规定范围内（例如 -5000 至 65000 分米）。

#### 2.3 关键传感器数据异常检测

##### 2.3.1 速度与加速度一致性

- **速度比较**
  - 通过比较 GNSS 速度（velocityGNSS）与 CAN 速度（velocityCAN），允许差值不超过 5 m/s。
  - 如果两者差值超过 5 m/s，说明可能存在传感器采集误差或数据传输问题。
- **加速度范围检测**
  - 纵向加速度、横向加速度和垂向加速度要求转换后均在 [-10, +10] m/s²内。
  - 任何一项若超出该范围（如横向加速度 156.0 或垂向加速度 145.0），均认为该项数据异常。

##### 2.3.2 转向及横摆检测

- **方向盘转角**
  - 将原始 steeringAngle 除以 10,000 后，得到的实际转角绝对值不应超过 1000°（一般乘用车方向盘转角远小于此值，具体阈值可根据车型进行微调）。
  - 如果检测到转换后角度超过此上限，则说明传感器数据异常或数据传输错误。
- **横摆角速度**
  - 虽然 yawRate 的具体数值阈值依据车辆设计和动态特性可能不同，但一般应在 ±100°/s 范围内；
  - 此外，还需将 yawRate 与方向盘转角变化趋势进行关联对比，若两者不匹配（例如转角剧烈而 yawRate 几乎不变，或反之），可认为存在异常。

##### 2.3.3 制动系统检测

- **制动状态一致性**
  - 当 brakeFlag 为 1（表示踩下制动踏板）时：
    - brakePos 应不低于 50（即 5% 以上的开度）；
    - brakePressure 应不低于 5000（单位 0.01 MPa，即相当于 50 MPa 的压力值，根据车辆特性可能需要调整）。
  - 当 brakeFlag 为 0（未踩制动）时：
    - brakePos 和 brakePressure 应接近 0；若检测到有非零值，则判定数据异常。

##### 2.3.4 发动机状态检测

- **转速与扭矩逻辑**
  - 发动机转速 engineSpeed 正常运行时一般应大于 50 rpm；
  - 如果 engineSpeed 小于 50 rpm，则 engineTorque 理应非常低（例如不超过 500，单位 0.01 Nm），否则表明存在采集错误。
  - 异常情况如：engineSpeed=12 rpm 但 engineTorque=5600，应视为数据不符，提示故障或传感器异常。

##### 2.3.5 驾驶模式与数据匹配

- **驾驶模式判断**
  - driveMode 的取值需在规定范围内（通常为 1~9，其中 0xFF 为无效）；
  - 针对不同驾驶模式（如人工驾驶、自动驾驶、云控支持驾驶等），要求车辆的加速、转向和制动数据表现出相应的动态特性。
    - 例如，在自动驾驶模式下，车辆行驶数据应较为平稳；若出现剧烈波动，则可能为数据异常或系统故障。
- **时间戳同步**
  - 对比同一数据包中不同时间戳（timestampGNSS、timestamp3、timestamp4），若它们之间的差异超过 100 毫秒，则表明数据采集或传输存在延迟或同步问题。

------

### 3. 异常检测结果的整合

在完成以上各项检测后，系统将对每个关键数据项进行打分或记录异常项，具体步骤如下：

1. **逐项检测**：
   - 对每个字段按照上述阈值进行检查；
   - 若某一项数据超出预设范围，记录该异常信息，包括参数名称、实际值、预期范围以及异常说明。
2. **异常汇总**：
   - 将所有异常项整理成列表，对比异常数量和严重程度；
   - 如果有一项或多项关键参数异常，则整体判定为“异常”，否则为“正常”。
3. **异常报告生成**：
   - 输出结构化报告，包含车辆基本信息（vehicleId、messageId、时间戳）以及详细的异常项列表；
   - 该报告可用于后续告警、日志记录或人工审核。

例如，对于示例数据可能生成如下的异常报告（具体格式可由系统设计决定）：

- **车辆基本信息**：vehicleId、messageId、采集时间戳
- **异常项**：
  - 加速度检测：横向加速度 156.0 m/s²（预期范围 [-10, +10] m/s²）；
  - 加速度检测：垂向加速度 145.0 m/s²（预期范围 [-10, +10] m/s²）；
  - 转向检测：方向盘转角 10200000（原始数据，转换后约 1020°，超出预期 1000° 范围）；
  - 速度一致性：GNSS 速度与 CAN 速度相差超过 5 m/s（例如 7.9 m/s 与 0 m/s）。

------

### 4. 业务逻辑总结

1. **数据接收与预处理**
   - 从 JSON 中提取所有必要字段并进行单位转换；
   - 检查车辆编号、消息编号及时间戳的合法性。
2. **基础数据校验**
   - 定位数据是否在合法范围内；
   - 时间戳是否合理且同步。
3. **关键参数检测**
   - **速度一致性**：GNSS 与 CAN 速度的差值 ≤ 5 m/s；
   - **加速度检测**：纵向、横向、垂向加速度均在 [-10, +10] m/s²；
   - **转向检测**：方向盘转角（转换后）绝对值 < 1000°；
      横摆角速度与转向数据匹配；
   - **制动系统检测**：若制动标志有效，brakePos ≥ 50 且 brakePressure ≥ 5000，否则为异常；
   - **发动机状态检测**：发动机转速应 ≥ 50 rpm，低转速下扭矩应极低；
   - **驾驶模式判断**：driveMode 取值合法，并与其他传感器数据动态特性一致；
   - **时间戳同步**：各时间戳差异 ≤ 100 毫秒。
4. **异常报告输出**
   - 将所有超出阈值的检测项生成详细报告，报告中列明每个异常的具体参数、实际值、合理范围以及异常说明；
   - 报告作为告警、日志记录或后续分析的依据。
